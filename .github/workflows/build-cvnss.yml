name: Build VietIME CVNSS (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Không phụ thuộc global.json để tránh fail kiểu "file not found"
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # Cài thêm .NET 6 để cover trường hợp project target net6.0-windows
      - name: Setup .NET 6 (compat)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Pick project to publish
        id: pick
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Ưu tiên path chuẩn của repo bạn
          if (Test-Path "src/VietIME.App/VietIME.App.csproj") {
            $proj = "src/VietIME.App/VietIME.App.csproj"
          }
          elseif (Test-Path "src/VietIME/VietIME.csproj") {
            $proj = "src/VietIME/VietIME.csproj"
          }
          else {
            # Fallback: tự dò project executable
            $candidates = Get-ChildItem -Path "src" -Filter *.csproj -Recurse -ErrorAction SilentlyContinue
            if (-not $candidates) { throw "No .csproj found under src/" }

            $proj = $null
            foreach ($f in $candidates) {
              if ($f.FullName -match "\\VietIME\.Core\\") { continue }
              if ($f.FullName -match "\\VietIME\.Hook\\") { continue }
              $xml = Get-Content $f.FullName -Raw

              # Ưu tiên WPF/WinForms (thường là app)
              if ($xml -match "<UseWPF>\s*true\s*</UseWPF>" -or $xml -match "<UseWindowsForms>\s*true\s*</UseWindowsForms>") {
                $proj = $f.FullName; break
              }

              # Hoặc OutputType Exe/WinExe
              if ($xml -match "<OutputType>\s*WinExe\s*</OutputType>" -or $xml -match "<OutputType>\s*Exe\s*</OutputType>") {
                $proj = $f.FullName; break
              }
            }

            if (-not $proj) { $proj = ($candidates | Select-Object -First 1).FullName }
          }

          "project=$proj" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Publishing project: $proj"
          Write-Host "Dotnet info:"
          dotnet --info

      - name: Restore
        shell: pwsh
        run: dotnet restore "${{ steps.pick.outputs.project }}"

      - name: Publish (SingleFile, win-x64)
        shell: pwsh
        run: |
          $proj = "${{ steps.pick.outputs.project }}"
          dotnet publish $proj -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            -o out/publish

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VietIME-CVNSS-win-x64
          path: out/publish/
